<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi Portefeuille PEA ‚Äì v6 PRO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#020617" />
  <link rel="manifest" href="manifest.webmanifest" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#020617;
      color:#e5e7eb;
    }
    header{
      background:radial-gradient(circle at top left,#0ea5e9,#22c55e 40%,#020617 90%);
      padding:1.2rem 1.5rem 1rem;
      border-bottom:1px solid rgba(148,163,184,.4);
    }
    header h1{margin:0;font-size:1.35rem;font-weight:650;letter-spacing:.03em}
    header span{font-size:.85rem;opacity:.85}
    main{max-width:1180px;margin:.5rem auto 2rem;padding:0 1rem}
    .top-bar{display:flex;justify-content:space-between;align-items:center;gap:.75rem;margin:.7rem 0 .5rem;flex-wrap:wrap}
    .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
    .tab-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      padding:.4rem .85rem;
      font-size:.85rem;
      cursor:pointer;
      background:rgba(15,23,42,.8);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
    }
    .tab-btn span.dot{width:8px;height:8px;border-radius:999px;background:#475569}
    .tab-btn.active{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      border-color:transparent;
      color:#0b1120;
      font-weight:600;
    }
    .tab-btn.active span.dot{background:#0b1120}
    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      padding:.45rem .95rem;
      font-size:.85rem;
      font-weight:600;
      cursor:pointer;
      background:#0f172a;
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:.4rem;
    }
    .btn-danger{border-color:rgba(248,113,113,.6);color:#fecaca}
    .btn-danger:hover{background:rgba(248,113,113,.12)}
    .btn-primary{border-color:transparent;background:linear-gradient(135deg,#0ea5e9,#22c55e);color:#020617}
    .btn-ghost{background:transparent;border-color:rgba(148,163,184,.4);color:#e5e7eb}
    .card{
      background:#020617;
      border-radius:14px;
      padding:1rem 1.2rem;
      margin-bottom:1rem;
      border:1px solid rgba(148,163,184,.35);
      box-shadow:0 18px 40px rgba(15,23,42,.6);
    }
    .card h2{margin:0 0 .55rem;font-size:1.02rem;font-weight:600}
    .card h3{margin:.2rem 0 .45rem;font-size:.95rem;font-weight:600}
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(130px,1fr));
      gap:.6rem .8rem;
      margin-bottom:.8rem;
    }
    label{font-size:.78rem;display:block;margin-bottom:.18rem;color:#9ca3af}
    input,select,textarea{
      width:100%;
      padding:.38rem .5rem;
      border-radius:8px;
      border:1px solid rgba(55,65,81,.9);
      background:#020617;
      color:#e5e7eb;
      font-size:.88rem;
      resize:vertical;
    }
    input::placeholder,textarea::placeholder{color:#6b7280}
    table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:.4rem}
    th,td{
      border-bottom:1px solid rgba(30,41,59,.9);
      padding:.35rem .3rem;
      text-align:center;
      white-space:nowrap;
    }
    th{background:#020617;color:#9ca3af}
    tr:nth-child(even) td{background:rgba(15,23,42,.6)}
    tr:nth-child(odd) td{background:rgba(15,23,42,.3)}
    .text-left{text-align:left}
    .text-right{text-align:right}
    .text-small{font-size:.78rem;color:#9ca3af}
    .kpi-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
      gap:.6rem;
    }
    .kpi{
      background:#020617;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.4);
      padding:.5rem .7rem;
    }
    .kpi-label{font-size:.7rem;color:#9ca3af}
    .kpi-value{font-size:1rem;font-weight:600;margin-top:.1rem}
    .kpi-value.positive{color:#4ade80}
    .kpi-value.negative{color:#f87171}
    .tag{
      padding:.08rem .45rem;
      border-radius:999px;
      font-size:.72rem;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:.18rem;
    }
    .tag-achat{background:rgba(45,212,191,.12);color:#6ee7b7}
    .tag-vente{background:rgba(248,113,113,.12);color:#fecaca}
    .badge-note{
      background:rgba(56,189,248,.1);
      color:#7dd3fc;
      border-radius:999px;
      padding:.05rem .4rem;
      font-size:.7rem;
      margin-left:.35rem;
    }
    .hidden{display:none}
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal{
      background:#020617;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.4);
      padding:1rem 1.2rem;
      width:min(420px,100% - 2rem);
      box-shadow:0 24px 60px rgba(15,23,42,.9);
      animation:modalIn .16s ease-out;
    }
    @keyframes modalIn{from{transform:translateY(10px);opacity:0}to{transform:translateY(0);opacity:1}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .modal-title{font-size:.95rem;font-weight:600}
    .modal-footer{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.7rem}
    .chart-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:1rem;
      margin-top:.6rem;
    }
    canvas{
      background:#020617;
      border-radius:12px;
      border:1px solid rgba(30,41,59,.9);
      padding:.4rem;
      transition: filter 0.2s ease;
    }
    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:.4rem;
      margin-top:.4rem;
    }
    .chip-btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.5);
      padding:.18rem .6rem;
      font-size:.78rem;
      background:#020617;
      color:#e5e7eb;
      cursor:pointer;
    }
    .chip-btn.active{
      border-color:transparent;
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#020617;
      font-weight:600;
    }
    @media (max-width:640px){
      main{padding:0 .6rem}
      th,td{font-size:.76rem}
    }
  </style>
</head>
<body>
<header>
  <h1>Suivi Portefeuille PEA</h1>
  <span>Op√©rations ‚Ä¢ Cash ‚Ä¢ R√©sum√© ‚Ä¢ Portefeuille ‚Ä¢ Dividendes ‚Ä¢ PV ‚Ä¢ PRU ‚Ä¢ Graphiques ‚Ä¢ Watchlist</span>
</header>

<main>
  <div class="top-bar">
    <div class="tabs">
      <button class="tab-btn active" data-tab="tab-saisie"><span class="dot"></span> Saisie rapide</button>
      <button class="tab-btn" data-tab="tab-historique"><span class="dot"></span> Historique</button>
      <button class="tab-btn" data-tab="tab-resume"><span class="dot"></span> R√©sum√©</button>
      <button class="tab-btn" data-tab="tab-portefeuille"><span class="dot"></span> Portefeuille</button>
      <button class="tab-btn" data-tab="tab-dividendes"><span class="dot"></span> Dividendes</button>
      <button class="tab-btn" data-tab="tab-pv"><span class="dot"></span> PV r√©alis√©es</button>
      <button class="tab-btn" data-tab="tab-pru"><span class="dot"></span> Calculatrice PRU</button>
      <button class="tab-btn" data-tab="tab-graphs"><span class="dot"></span> Graphiques</button>
      <button class="tab-btn" data-tab="tab-watchlist"><span class="dot"></span> Watchlist</button>
    </div>

    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è R√©initialiser</button>
  </div>

  <!-- ========== SAISIE RAPIDE ========== -->
  <section id="tab-saisie" class="tab-panel">
    <div class="card">
      <h2>Nouvelle op√©ration</h2>

      <div class="form-grid">
        <div><label>Date</label><input type="date" id="date" /></div>
        <div><label>Ticker</label><input type="text" id="ticker" placeholder="Ex : TTE, BNP" /></div>
        <div>
          <label>Type</label>
          <select id="type">
            <option value="achat">Achat</option>
            <option value="vente">Vente</option>
          </select>
        </div>
        <div><label>Quantit√©</label><input type="number" id="quantity" step="0.01" /></div>
        <div><label>Prix (‚Ç¨)</label><input type="number" id="price" step="0.0001" /></div>
        <div><label>Frais (‚Ç¨)</label><input type="number" id="fees" step="0.01" value="0" /></div>
      </div>

      <button class="btn btn-primary" onclick="addOperation()">Ajouter l'op√©ration</button>
      <p class="text-small" style="margin-top:.5rem;">Les tickers sont normalis√©s (TTE ‚Üí TTE.PA).</p>
    </div>

    <div class="card">
      <h2>Mouvements de cash PEA</h2>
      <div class="form-grid">
        <div><label>Date</label><input type="date" id="cash-date" /></div>
        <div>
          <label>Type de mouvement</label>
          <select id="cash-type">
            <option value="in">D√©p√¥t sur le PEA</option>
            <option value="out">Retrait du PEA</option>
          </select>
        </div>
        <div><label>Montant (‚Ç¨)</label><input type="number" id="cash-amount" step="0.01" /></div>
      </div>

      <button class="btn btn-primary" onclick="addCashMovement()">Ajouter le mouvement de cash</button>
      <p class="text-small" style="margin-top:.5rem;">Pris en compte dans le cash th√©orique du r√©sum√©.</p>
    </div>
  </section>

  <!-- ========== HISTORIQUE ========== -->
  <section id="tab-historique" class="tab-panel hidden">
    <div class="card">
      <h2>Historique des op√©rations</h2>
      <p class="text-small">Toutes les op√©rations saisies, dans l'ordre chronologique.</p>

      <div style="overflow-x:auto;max-height:260px;">
        <table id="operationsTable">
          <thead>
            <tr>
              <th>Date</th>
              <th class="text-left">Valeur</th>
              <th>Type</th>
              <th>Qt√©</th>
              <th>PU (‚Ç¨)</th>
              <th>Frais (‚Ç¨)</th>
              <th>Montant (‚Ç¨)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Mouvements de cash PEA</h2>
      <p class="text-small">Historique des d√©p√¥ts et retraits d√©clar√©s dans la section ‚ÄúMouvements de cash PEA‚Äù.</p>

      <div style="overflow-x:auto;max-height:260px;">
        <table id="cashTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th class="text-right">Montant (‚Ç¨)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ========== R√âSUM√â ========== -->
  <section id="tab-resume" class="tab-panel hidden">
    <div class="card">
      <h2>R√©sum√© du portefeuille</h2>
      <p class="text-small">
        Calcul√© √† partir des op√©rations, des mouvements de cash, des dividendes d√©tach√©s
        et des cours (via Yahoo + Alpha pour 1J).
      </p>

      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Valeur totale</div>
          <div class="kpi-value" id="kpiValeurTotale">‚Äì</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">Investi actuel</div>
          <div class="kpi-value" id="kpiInvestiActuel">‚Äì</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">PV latente</div>
          <div class="kpi-value" id="kpiPVLatente">‚Äì</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">PV r√©alis√©es</div>
          <div class="kpi-value" id="kpiPVReal">‚Äì</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">Dividendes encaiss√©s</div>
          <div class="kpi-value" id="kpiDivRecus">‚Äì</div>
        </div>

        <div class="kpi">
          <div class="kpi-label">Cash th√©orique</div>
          <div class="kpi-value" id="kpiCash">‚Äì</div>
        </div>
      </div>

      <p class="text-small" style="margin-top:.6rem;">
        * Pour la valeur et PV latente : mettre √† jour les cours dans l‚Äôonglet Portefeuille.
      </p>
    </div>
  </section>
  <!-- ========== PORTEFEUILLE ========== -->
<section id="tab-portefeuille" class="tab-panel hidden">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap;">
      <h2>Portefeuille ‚Äì Positions actuelles</h2>
      <div style="display:flex;gap:.4rem;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="refreshAllPrices()">üîÑ Mettre √† jour les cours</button>
        <button class="btn btn-ghost" onclick="clearPrices()">üßπ Effacer les cours</button>
      </div>
    </div>

    <p class="text-small">
      R√©sultat bas√© sur les op√©rations, et sur les cours Yahoo (via fonction Netlify).
      Pour le 1J, Alpha Vantage sera utilis√© dans la partie Graphiques / Watchlist.
    </p>

    <div style="overflow-x:auto;max-height:360px;">
      <table id="portfolioTable">
        <thead>
          <tr>
            <th class="text-left">Valeur</th>
            <th>Qt√©</th>
            <th>PRU (‚Ç¨)</th>
            <th>Cours</th>
            <th>Valo (‚Ç¨)</th>
            <th>Latent (‚Ç¨)</th>
            <th>Latent (%)</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="text-small" id="pricesInfo" style="margin-top:.6rem;">
      Aucun cours enregistr√© pour l‚Äôinstant.
    </p>
  </div>
</section>

<!-- ========== DIVIDENDES ========== -->
<section id="tab-dividendes" class="tab-panel hidden">
  <div class="card">
    <h2>Dividendes ‚Äì Configuration</h2>
    <p class="text-small">
      Configure le dividende par action, jusqu‚Äô√† 4 dates par an.
      Les dividendes encaiss√©s s'ajoutent automatiquement au cash th√©orique.
    </p>

    <div class="form-grid">
      <div><label>Ticker</label><input type="text" id="div-ticker" placeholder="Ex : TTE, BNP" /></div>
      <div><label>Dividende / action (‚Ç¨)</label>
        <input type="number" id="div-montant" step="0.0001" />
      </div>

      <div><label>Nb distributions (1 √† 4)</label>
        <input type="number" id="div-freq" min="1" max="4" />
      </div>

      <div><label>Date 1</label><input type="date" id="div-date1" /></div>
      <div><label>Date 2</label><input type="date" id="div-date2" /></div>
      <div><label>Date 3</label><input type="date" id="div-date3" /></div>
      <div><label>Date 4</label><input type="date" id="div-date4" /></div>
    </div>

    <button class="btn btn-primary" onclick="addDividend()">Ajouter / Mettre √† jour</button>

    <div style="margin-top:.6rem;">
      <span id="nextDivInfo" class="text-small">Prochain dividende : aucun d√©tect√©.</span>
    </div>

    <div style="overflow-x:auto;max-height:260px;margin-top:.8rem;">
      <table id="dividendsTable">
        <thead>
          <tr>
            <th class="text-left">Valeur</th>
            <th>Nb actions</th>
            <th>Div / act.</th>
            <th>Distributions</th>
            <th>Annuel (‚Ç¨)</th>
            <th>Dates</th>
            <th>Prochaine</th>
            <th>Per√ßu (‚Ç¨)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>

        <tfoot>
          <tr>
            <td colspan="4" class="text-right"><strong>Total annuel</strong></td>
            <td id="totalDivAnnuel"></td>
            <td colspan="4"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="card">
    <h3>Historique des dividendes encaiss√©s</h3>
    <p class="text-small">Bas√© sur les dates d√©j√† pass√©es et les quantit√©s d√©tenues √† chaque date.</p>

    <div style="overflow-x:auto;max-height:260px;">
      <table id="divHistoryTable">
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-left">Valeur</th>
            <th>Qt√© √† la date</th>
            <th>Div / act.</th>
            <th>Montant (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody></tbody>

        <tfoot>
          <tr>
            <td colspan="4" class="text-right"><strong>Total encaiss√©</strong></td>
            <td id="totalDivHistory"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</section>
<!-- ========== PV R√âALIS√âES ========== -->
<section id="tab-pv" class="tab-panel hidden">
  <div class="card">
    <h2>Plus-values r√©alis√©es ‚Äì Historique</h2>
    <p class="text-small">Bas√©es sur le PRU au moment de chaque vente, net des frais.</p>

    <div style="overflow-x:auto;max-height:360px;">
      <table id="pvTable">
        <thead>
          <tr>
            <th>Date</th>
            <th class="text-left">Valeur</th>
            <th>Qt√©</th>
            <th>PRU (‚Ç¨)</th>
            <th>Prix vente (‚Ç¨)</th>
            <th>Frais (‚Ç¨)</th>
            <th>PV (‚Ç¨)</th>
            <th>PV (%)</th>
          </tr>
        </thead>
        <tbody></tbody>

        <tfoot>
          <tr>
            <td colspan="6" class="text-right"><strong>Total PV</strong></td>
            <td id="totalPV"></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</section>

<!-- ========== CALCULATRICE PRU ========== -->
<section id="tab-pru" class="tab-panel hidden">
  <div class="card">
    <h2>Calculatrice de PRU & objectifs</h2>
    <p class="text-small">
      Simule un renforcement ou une vente partielle, et calcule la plus-value sur un objectif de cours.
    </p>

    <div class="form-grid">
      <div>
        <label>Ticker (optionnel)</label>
        <input type="text" id="pru-ticker" placeholder="Ex : TTE, BNP" />
      </div>

      <div>
        <label>PRU actuel (‚Ç¨)</label>
        <input type="number" id="pru-current" step="0.0001" />
      </div>

      <div>
        <label>Quantit√© actuelle</label>
        <input type="number" id="pru-current-qty" step="0.01" />
      </div>
    </div>

    <h3>Simulation de renforcement</h3>
    <div class="form-grid">
      <div>
        <label>Qt√© achat</label>
        <input type="number" id="pru-add-qty" step="0.01" />
      </div>

      <div>
        <label>Prix achat (‚Ç¨)</label>
        <input type="number" id="pru-add-price" step="0.0001" />
      </div>

      <div>
        <label>Frais (‚Ç¨)</label>
        <input type="number" id="pru-add-fees" step="0.01" value="0" />
      </div>
    </div>

    <div class="kpi-row" style="margin-top:.4rem;">
      <div class="kpi">
        <div class="kpi-label">Nouveau PRU</div>
        <div class="kpi-value" id="pru-new">‚Äì</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Montant total investi</div>
        <div class="kpi-value" id="pru-total-invest">‚Äì</div>
      </div>
    </div>

    <h3 style="margin-top:.8rem;">Objectif de cours</h3>

    <div class="form-grid">
      <div>
        <label>Prix objectif (‚Ç¨)</label>
        <input type="number" id="pru-target-price" step="0.0001" />
      </div>

      <div>
        <label>Gain souhait√© (‚Ç¨)</label>
        <input type="number" id="pru-target-gain" step="0.01" />
      </div>
    </div>

    <div class="kpi-row" style="margin-top:.4rem;">
      <div class="kpi">
        <div class="kpi-label">PV √† l‚Äôobjectif (‚Ç¨)</div>
        <div class="kpi-value" id="pru-target-pl">‚Äì</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">PV √† l‚Äôobjectif (%)</div>
        <div class="kpi-value" id="pru-target-pl-pct">‚Äì</div>
      </div>

      <div class="kpi">
        <div class="kpi-label">Prix cible</div>
        <div class="kpi-value" id="pru-target-price-from-gain">‚Äì</div>
      </div>
    </div>

  </div>
</section>
<!-- ========== GRAPHIQUES ========== -->
<section id="tab-graphs" class="tab-panel hidden">
  <div class="card">
    <h2>Graphiques du portefeuille</h2>
    <p class="text-small">
      Bas√©s sur les positions actuelles, les cours enregistr√©s (Yahoo via Netlify) et l‚Äôhistorique des op√©rations / dividendes.
    </p>

    <div class="chart-grid">
      <div>
        <h3>R√©partition par valeur</h3>
        <canvas id="chartAlloc"></canvas>
      </div>

      <div>
        <h3>PV latente par valeur</h3>
        <p class="text-small">
          Barres au-dessus de z√©ro = gain latent, en dessous = perte latente (bas√© sur les cours enregistr√©s).
        </p>
        <canvas id="chartPL"></canvas>
      </div>
    </div>

    <h3 style="margin-top:1.2rem;">D√©tail par valeur (cours)</h3>
    <p class="text-small">
      S√©lectionne un ticker pour voir la courbe du cours de bourse (donn√©es Yahoo via Netlify, p√©riode au choix).
    </p>

    <div class="form-grid" style="margin-bottom:.4rem;">
      <div>
        <label>Valeur</label>
        <select id="tickerDetailSelect"></select>
      </div>

      <div style="display:flex;align-items:flex-end;">
        <button class="btn btn-primary" type="button" onclick="refreshCurrentTickerSeries()">
          üîÑ Recharger ce ticker
        </button>
      </div>
    </div>

    <div class="chip-row" id="tickerPeriodRow">
      <button class="chip-btn" data-ticker-period="1J">1J</button>
      <button class="chip-btn" data-ticker-period="1S">1S</button>
      <button class="chip-btn" data-ticker-period="1M">1M</button>
      <button class="chip-btn" data-ticker-period="3M">3M</button>
      <button class="chip-btn active" data-ticker-period="6M">6M</button>
      <button class="chip-btn" data-ticker-period="1A">1A</button>
      <button class="chip-btn" data-ticker-period="2A">2A</button>
      <button class="chip-btn" data-ticker-period="5A">5A</button>
      <button class="chip-btn" data-ticker-period="MAX">Max</button>
    </div>

    <canvas id="chartTickerDetail" style="margin-top:.4rem;"></canvas>
    <p id="tickerCompareInfo" class="text-small" style="margin-top:.3rem;">
      Astuce : touche un point pour fixer la date de d√©part, puis un autre pour voir l'√©cart entre les deux.
    </p>

    <h3 style="margin-top:1.2rem;">Courbe portefeuille (avec / sans dividendes)</h3>
    <p class="text-small">
      Courbe bas√©e sur la valo des lignes + dividendes encaiss√©s.
      Ligne 1 = portefeuille sans dividendes, ligne 2 = portefeuille
      avec dividendes r√©investis (en les ajoutant √† la valeur).
    </p>

    <div class="chip-row" id="portfolioPeriodRow">
      <button class="chip-btn active" data-portfolio-period="6M">6M</button>
      <button class="chip-btn" data-portfolio-period="1A">1A</button>
      <button class="chip-btn" data-portfolio-period="2A">2A</button>
      <button class="chip-btn" data-portfolio-period="5A">5A</button>
      <button class="chip-btn" data-portfolio-period="MAX">Max</button>
    </div>

    <canvas id="chartPortfolioCurve" style="margin-top:.4rem;"></canvas>
    <p id="portfolioCompareInfo" class="text-small" style="margin-top:.3rem;">
      Astuce : touche un point pour fixer la date de d√©part, puis un autre pour voir l'√©volution entre les deux dates.
    </p>
  </div>
</section>

<!-- ========== WATCHLIST ========== -->
<section id="tab-watchlist" class="tab-panel hidden">
  <div class="card">
    <h2>Watchlist ‚Äì recherche de cours</h2>
    <p class="text-small">
      Recherche un ticker m√™me si tu ne le poss√®des pas. Le tableau ci-dessous n‚Äôest pas sauvegard√© (il dispara√Æt quand tu fermes l‚Äôappli).
    </p>

    <div class="form-grid">
      <div>
        <label>Ticker</label>
        <input type="text" id="watch-ticker-input" placeholder="Ex : TTE, SAN, NVDA" />
      </div>

      <div style="display:flex;align-items:flex-end;gap:.4rem;">
        <button class="btn btn-primary" type="button" onclick="addWatchTicker()">Ajouter au tableau</button>
        <button class="btn btn-ghost" type="button" onclick="clearWatchTable()">Vider le tableau</button>
      </div>
    </div>

    <div style="overflow-x:auto;max-height:260px;">
      <table id="watchlistTable">
        <thead>
          <tr>
            <th class="text-left">Ticker</th>
            <th>Dernier cours</th>
            <th>Var. jour (%)</th>
            <th>Favori</th>
            <th>Graphique</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <p class="text-small">
      Pour garder une valeur, mets-la en favori (max 4). Les favoris sont sauvegard√©s.
    </p>
  </div>

  <div class="card">
    <h3>Graphique watchlist (style Google)</h3>
    <p class="text-small">
      Clique sur un ticker du tableau ou sur un favori ci-dessous pour afficher sa courbe.
    </p>

    <div class="chip-row" id="watch-fav-row"></div>

    <div class="chip-row" id="watch-period-row">
      <button class="chip-btn" data-watch-period="1J">1J</button>
      <button class="chip-btn" data-watch-period="1S">1S</button>
      <button class="chip-btn" data-watch-period="1M">1M</button>
      <button class="chip-btn" data-watch-period="3M">3M</button>
      <button class="chip-btn active" data-watch-period="6M">6M</button>
      <button class="chip-btn" data-watch-period="1A">1A</button>
      <button class="chip-btn" data-watch-period="2A">2A</button>
      <button class="chip-btn" data-watch-period="5A">5A</button>
      <button class="chip-btn" data-watch-period="MAX">Max</button>
    </div>

    <canvas id="chartWatchlist" style="margin-top:.4rem;"></canvas>
    <p id="watchCompareInfo" class="text-small" style="margin-top:.3rem;">
      Astuce : touche un point pour fixer la date de d√©part, puis un autre pour voir l'√©cart entre les deux.
    </p>
  </div>
</section>

<!-- ========== MODALE NOTE ========== -->
<div id="noteModalBackdrop" class="modal-backdrop" style="display:none;">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="noteModalTitle">Note</div>
      <button class="btn btn-ghost" type="button" onclick="closeNoteModal()">‚úï</button>
    </div>

    <div>
      <label>Note (priv√©e)</label>
      <textarea id="noteModalTextarea" rows="5"
        placeholder="Ex : renforcer si le cours revient vers 50 ‚Ç¨, bons r√©sultats, etc."></textarea>
    </div>

    <div class="modal-footer">
      <button class="btn btn-ghost" type="button" onclick="closeNoteModal()">Annuler</button>
      <button class="btn btn-primary" type="button" onclick="saveNoteModal()">Enregistrer</button>
    </div>
  </div>
</div>
<script>
/* ========= 1. STORAGE / CONFIG ========= */
const STORAGE_OPS            = "pea_ops_v6";
const STORAGE_DIVCFG         = "pea_div_cfg_v6";
const STORAGE_CASH           = "pea_cash_v6";
const STORAGE_NOTES          = "pea_notes_v6";
const STORAGE_PRICES         = "pea_prices_v6";
const STORAGE_SERIES         = "pea_series_v1";
const STORAGE_SERIES_INTRADAY= "pea_series_intraday_v1";
const STORAGE_WATCH_FAV      = "pea_watch_fav_v1";

/* Appelle la fonction Netlify du site courant */
const YAHOO_ENDPOINT = "/.netlify/functions/yahoo";
const ALPHA_ENDPOINT = "/.netlify/functions/alpha";

function loadJSON(k,d){try{const r=localStorage.getItem(k);return r?JSON.parse(r):d}catch{return d}}
function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v))}

let operations      = loadJSON(STORAGE_OPS,[]);
let dividends       = loadJSON(STORAGE_DIVCFG,[]);
let cashMoves       = loadJSON(STORAGE_CASH,[]);
let notes           = loadJSON(STORAGE_NOTES,{});
let prices          = loadJSON(STORAGE_PRICES,{});
let priceSeries     = loadJSON(STORAGE_SERIES,{});
let intradaySeries  = loadJSON(STORAGE_SERIES_INTRADAY,{});
let watchFavorites  = loadJSON(STORAGE_WATCH_FAV,[]); // max 4 tickers

if(!notes || typeof notes !== "object" || Array.isArray(notes)) notes = {};
if(!priceSeries || typeof priceSeries !== "object" || Array.isArray(priceSeries)) priceSeries = {};
if(!intradaySeries || typeof intradaySeries !== "object" || Array.isArray(intradaySeries)) intradaySeries = {};
if(!Array.isArray(watchFavorites)) watchFavorites = [];

let watchRows = []; // tableau en m√©moire (non sauvegard√©)

let autoPriceRefreshed     = false;
let autoSeriesRefreshed    = false;
let currentTickerPeriod    = "6M";
let currentPortfolioPeriod = "6M";
let currentWatchPeriod     = "6M";
let currentWatchTicker     = null;

/* ========= 2. ONGLET / UI ========= */
const tabButtons=document.querySelectorAll(".tab-btn");
const tabPanels=document.querySelectorAll(".tab-panel");

tabButtons.forEach(function(btn){
  btn.addEventListener("click",function(){
    const target=btn.dataset.tab;
    tabButtons.forEach(b=>b.classList.toggle("active",b===btn));
    tabPanels.forEach(p=>p.classList.toggle("hidden",p.id!==target));

    if(target==="tab-portefeuille" && !autoPriceRefreshed){
      autoPriceRefreshed=true;
      refreshAllPrices(true);
    }
    if(target==="tab-graphs" && !autoSeriesRefreshed){
      autoSeriesRefreshed=true;
      refreshAllSeries(true);
    }
  });
});

function normalizeTicker(raw){
  if(!raw)return"";
  let t=raw.toUpperCase().replace(/\s+/g,"");
  if(t && !t.includes("."))t+=".PA";
  return t;
}

function fmtEuro(v){if(isNaN(v))return"‚Äì";return v.toFixed(2)+" ‚Ç¨";}
function fmtPct(v){if(isNaN(v))return"‚Äì";return v.toFixed(2)+" %";}

/* ========= 3. OPERATIONS & CASH ========= */
function addOperation(){
  const date=document.getElementById("date").value;
  const tickerInput=document.getElementById("ticker").value.trim();
  const type=document.getElementById("type").value;
  const quantity=parseFloat((document.getElementById("quantity").value||"").replace(",","."));  
  const price=parseFloat((document.getElementById("price").value||"").replace(",","."));  
  const fees=parseFloat((document.getElementById("fees").value||"0").replace(",","."));  

  if(!date||!tickerInput||!quantity||!price){
    alert("Date, ticker, quantit√© et prix sont obligatoires.");
    return;
  }
  if(quantity<=0||price<=0){
    alert("Quantit√© et prix doivent √™tre > 0.");
    return;
  }

  const ticker=normalizeTicker(tickerInput);
  const op={id:Date.now()+Math.random(),date,ticker,type,quantity,price,fees:isNaN(fees)?0:fees};
  operations.push(op);
  operations.sort((a,b)=>a.date.localeCompare(b.date)||a.id-b.id);
  saveJSON(STORAGE_OPS,operations);
  renderAll();
  document.getElementById("quantity").value="";
  document.getElementById("price").value="";
  document.getElementById("fees").value="0";
}

function addCashMovement(){
  const date=document.getElementById("cash-date").value;
  const type=document.getElementById("cash-type").value;
  const amount=parseFloat((document.getElementById("cash-amount").value||"").replace(",","."));  

  if(!date||!amount||amount<=0){
    alert("Date et montant (>0) obligatoires.");
    return;
  }

  const move={id:Date.now()+Math.random(),date,type,amount};
  cashMoves.push(move);
  cashMoves.sort((a,b)=>a.date.localeCompare(b.date)||a.id-b.id);
  saveJSON(STORAGE_CASH,cashMoves);
  renderSummary();
  renderCashHistory();
  document.getElementById("cash-amount").value="";
}

function deleteOperation(id){
  if(!confirm("Supprimer cette op√©ration ?"))return;
  operations=operations.filter(op=>op.id!==id);
  saveJSON(STORAGE_OPS,operations);
  renderAll();
}

/* ========= 4. POSITIONS / PV R√âALIS√âES ========= */
function computeFromOperations(){
  const positions={};
  const realized=[];
  let totalBuys=0,totalSells=0;

  const opsSorted=operations.slice().sort((a,b)=>a.date.localeCompare(b.date)||a.id-b.id);

  opsSorted.forEach(op=>{
    if(!positions[op.ticker])positions[op.ticker]={quantity:0,cost:0};
    const pos=positions[op.ticker];

    if(op.type==="achat"){
      const totalCost=op.quantity*op.price+op.fees;
      pos.quantity+=op.quantity;
      pos.cost+=totalCost;
      totalBuys+=totalCost;
    }else if(op.type==="vente"){
      const proceeds=op.quantity*op.price-op.fees;
      totalSells+=proceeds;

      if(pos.quantity<=0){
        realized.push({
          date:op.date,
          ticker:op.ticker,
          qty:op.quantity,
          pruBefore:0,
          price:op.price,
          fees:op.fees,
          pl:proceeds,
          plPct:0
        });
      }else{
        const currentPRU=pos.cost/pos.quantity;
        const costBasis=currentPRU*op.quantity;
        const pl=proceeds-costBasis;
        const plPct=costBasis?(pl/costBasis)*100:0;

        realized.push({
          date:op.date,
          ticker:op.ticker,
          qty:op.quantity,
          pruBefore:currentPRU,
          price:op.price,
          fees:op.fees,
          pl,
          plPct
        });

        pos.quantity-=op.quantity;
        pos.cost-=costBasis;
        if(pos.quantity<=1e-8){pos.quantity=0;pos.cost=0;}
      }
    }
  });

  const totalPV=realized.reduce((s,r)=>s+r.pl,0);
  return{positions,realized,totalBuys,totalSells,totalPV,opsSorted};
}

function getQuantityAtDate(ticker,dateISO){
  let qty=0;
  const info=computeFromOperations();
  const opsSorted=info.opsSorted;
  for(let i=0;i<opsSorted.length;i++){
    const op=opsSorted[i];
    if(op.ticker!==ticker)continue;
    if(op.date>dateISO)break;
    qty+=(op.type==="achat"?op.quantity:-op.quantity);
  }
  return Math.max(0,qty);
}

/* ========= 5. DIVIDENDES ========= */
function computeDividendsReceived(){
  if(!dividends.length||!operations.length)return{total:0,perTicker:{},events:[]};
  const today=new Date().toISOString().slice(0,10);
  const events=[];
  const perTicker={};
  let total=0;

  dividends.forEach(d=>{
    if(!d.dates||!d.dates.length)return;
    d.dates.forEach(date=>{
      if(date>today)return;
      const qty=getQuantityAtDate(d.ticker,date);
      if(qty<=0)return;
      const amount=qty*d.montant;
      events.push({date,ticker:d.ticker,qty,perShare:d.montant,amount});
      perTicker[d.ticker]=(perTicker[d.ticker]||0)+amount;
      total+=amount;
    });
  });

  events.sort((a,b)=>a.date.localeCompare(b.date));
  return{total,perTicker,events};
}

/* ========= 6. PORTFOLIO + PRIX ========= */
function computePortfolioWithPrices(){
  const info=computeFromOperations();
  const positions=info.positions;
  const result=[];
  let totalValo=0,totalCost=0,totalPL=0;

  Object.keys(positions).forEach(t=>{
    const pos=positions[t];
    if(pos.quantity<=0)return;
    const qty=pos.quantity;
    const cost=pos.cost;
    const pru=cost/qty;
    const priceObj=prices[t];
    const price=priceObj?priceObj.price:null;
    const valo=price?price*qty:cost;
    const pl=price?(price-pru)*qty:0;
    const plPct=price?((price-pru)/pru)*100:0;

    totalValo+=valo;
    totalCost+=cost;
    totalPL+=pl;

    result.push({ticker:t,qty,pru,cost,price,valo,pl,plPct});
  });

  return{lines:result,totalValo,totalCost,totalPL};
}

/* ========= 7. RENDU TABLEAUX ========= */
function renderOperations(){
  const tbody=document.querySelector("#operationsTable tbody");
  tbody.innerHTML="";
  if(!operations.length){
    tbody.innerHTML=`<tr><td colspan="8" class="text-small">Aucune op√©ration.</td></tr>`;
    return;
  }
  operations.forEach(op=>{
    const amount=op.quantity*op.price;
    tbody.innerHTML+=`
      <tr>
        <td>${op.date}</td>
        <td class="text-left">${op.ticker}</td>
        <td><span class="tag ${op.type==="achat"?"tag-achat":"tag-vente"}">${op.type}</span></td>
        <td>${op.quantity}</td>
        <td>${op.price.toFixed(4)}</td>
        <td>${op.fees.toFixed(2)}</td>
        <td>${amount.toFixed(2)}</td>
        <td><button class="btn btn-danger" onclick="deleteOperation(${op.id})">Suppr.</button></td>
      </tr>`;
  });
}

function renderCashHistory(){
  const tbody=document.querySelector("#cashTable tbody");
  if(!tbody)return;
  tbody.innerHTML="";
  if(!cashMoves.length){
    tbody.innerHTML=`<tr><td colspan="3" class="text-small">Aucun mouvement de cash.</td></tr>`;
    return;
  }
  cashMoves.forEach(m=>{
    const label=m.type==="in"?"D√©p√¥t sur le PEA":m.type==="out"?"Retrait du PEA":m.type;
    const signe=m.type==="in"?"+":"-";
    tbody.innerHTML+=`
      <tr>
        <td>${m.date}</td>
        <td>${label}</td>
        <td class="text-right">${signe}${m.amount.toFixed(2)} ‚Ç¨</td>
      </tr>`;
  });
}

/* Notes */
let currentNoteTicker=null;
function openNoteModal(ticker){
  currentNoteTicker=ticker;
  document.getElementById("noteModalTitle").textContent="Note pour "+ticker;
  document.getElementById("noteModalTextarea").value=notes[ticker]||"";
  document.getElementById("noteModalBackdrop").style.display="flex";
}
function closeNoteModal(){
  currentNoteTicker=null;
  document.getElementById("noteModalBackdrop").style.display="none";
}
function saveNoteModal(){
  if(!currentNoteTicker)return;
  const txt=document.getElementById("noteModalTextarea").value.trim();
  if(!txt)delete notes[currentNoteTicker];
  else notes[currentNoteTicker]=txt;
  saveJSON(STORAGE_NOTES,notes);
  closeNoteModal();
  renderPortfolio();
}

/* Portefeuille */
function renderPortfolio(){
  const tbody=document.querySelector("#portfolioTable tbody");
  tbody.innerHTML="";
  const info=computePortfolioWithPrices();
  const lines=info.lines;
  if(!lines.length){
    tbody.innerHTML=`<tr><td colspan="8" class="text-small">Aucune position ouverte.</td></tr>`;
    document.getElementById("pricesInfo").textContent="Aucune position.";
    return;
  }
  let haveAnyPrice=false;
  lines.forEach(l=>{
    if(l.price)haveAnyPrice=true;
    const noteText=notes[l.ticker]||"";
    const hasNote=noteText.trim().length>0;
    tbody.innerHTML+=`
      <tr>
        <td class="text-left">${l.ticker}${hasNote?'<span class="badge-note">Note</span>':""}</td>
        <td>${l.qty.toFixed(4)}</td>
        <td>${l.pru.toFixed(4)}</td>
        <td>${l.price?l.price.toFixed(4):"‚Äì"}</td>
        <td>${l.valo.toFixed(2)}</td>
        <td style="color:${l.pl>=0?"#4ade80":"#f87171"}">${l.pl.toFixed(2)}</td>
        <td style="color:${l.plPct>=0?"#4ade80":"#f87171"}">${l.plPct?l.plPct.toFixed(2):"0.00"}%</td>
        <td><button class="btn btn-ghost" type="button" onclick="openNoteModal('${l.ticker}')">üìù ${hasNote?"Modifier":"Ajouter"}</button></td>
      </tr>`;
  });
  const infoEl=document.getElementById("pricesInfo");
  infoEl.textContent=haveAnyPrice
    ?"Cours mis √† jour pour certaines valeurs (stock√©s localement)."
    :"Aucun cours enregistr√© : la valo et le latent utilisent le co√ªt d‚Äôachat. Clique sur ‚ÄúMettre √† jour les cours‚Äù.";
}

/* Dividendes config + histo */
function addDividend(){
  const tickerInput=document.getElementById("div-ticker").value.trim();
  const montant=parseFloat((document.getElementById("div-montant").value||"").replace(",","."));  
  const freq=parseInt(document.getElementById("div-freq").value||"0",10);
  const dates=[
    document.getElementById("div-date1").value||null,
    document.getElementById("div-date2").value||null,
    document.getElementById("div-date3").value||null,
    document.getElementById("div-date4").value||null
  ].filter(x=>x);

  if(!tickerInput||!montant||!freq){
    alert("Ticker, montant et fr√©quence sont obligatoires.");
    return;
  }
  const ticker=normalizeTicker(tickerInput);
  const idx=dividends.findIndex(d=>d.ticker===ticker);
  const obj={id:idx>=0?dividends[idx].id:Date.now()+Math.random(),ticker,montant,freq,dates};
  if(idx>=0)dividends[idx]=obj; else dividends.push(obj);
  saveJSON(STORAGE_DIVCFG,dividends);
  renderDividends();
}
function deleteDividend(id){
  if(!confirm("Supprimer ?"))return;
  dividends=dividends.filter(d=>d.id!==id);
  saveJSON(STORAGE_DIVCFG,dividends);
  renderDividends();
}
function renderDividends(){
  const tbody=document.querySelector("#dividendsTable tbody");
  tbody.innerHTML="";
  const totalAnnuelCell=document.getElementById("totalDivAnnuel");
  const nextInfo=document.getElementById("nextDivInfo");
  totalAnnuelCell.textContent="‚Äì";
  nextInfo.textContent="Prochain dividende : aucun d√©tect√©.";

  const opsInfo=computeFromOperations();
  const positions=opsInfo.positions;
  const divInfo=computeDividendsReceived();
  const total=divInfo.total;
  const perTicker=divInfo.perTicker;
  const events=divInfo.events;

  if(!dividends.length){
    tbody.innerHTML=`<tr><td colspan="9" class="text-small">Aucun dividende configur√©.</td></tr>`;
    document.getElementById("kpiDivRecus").textContent=fmtEuro(0);
    renderDivHistory(events);
    return;
  }

  let totalAnnual=0;
  let nextDividend=null;

  dividends.forEach(d=>{
    const qty=positions[d.ticker]?positions[d.ticker].quantity:0;
    const annuel=qty*d.montant*d.freq;
    totalAnnual+=annuel;

    let prochaine="‚Äì";
    let closest=null;
    if(d.dates&&d.dates.length){
      const today=new Date().toISOString().slice(0,10);
      d.dates.forEach(date=>{
        if(date>=today){
          if(!closest||date<closest)closest=date;
        }
      });
      prochaine=closest||"‚Äì";
      if(closest&&qty>0){
        const days=Math.round((new Date(closest)-new Date())/86400000);
        if(!nextDividend||new Date(closest)<new Date(nextDividend.date)){
          nextDividend={ticker:d.ticker,date:closest,days,montant:d.montant*qty};
        }
      }
    }

    const percus=perTicker[d.ticker]||0;
    tbody.innerHTML+=`
      <tr>
        <td class="text-left">${d.ticker}</td>
        <td>${qty?qty.toFixed(4):""}</td>
        <td>${d.montant.toFixed(4)}</td>
        <td>${d.freq}</td>
        <td>${annuel?annuel.toFixed(2):""}</td>
        <td>${d.dates.join("<br>")}</td>
        <td>${prochaine}</td>
        <td>${percus?percus.toFixed(2):""}</td>
        <td><button class="btn btn-danger" onclick="deleteDividend(${d.id})">Suppr.</button></td>
      </tr>`;
  });

  totalAnnuelCell.textContent=totalAnnual.toFixed(2)+" ‚Ç¨";
  document.getElementById("kpiDivRecus").textContent=fmtEuro(total);
  renderDivHistory(events);

  if(nextDividend){
    nextInfo.innerHTML=
      "Prochain dividende : <strong>"+nextDividend.ticker+
      "</strong> ‚Äì "+nextDividend.date+
      " ("+nextDividend.days+" jours) ‚Äì ~"+nextDividend.montant.toFixed(2)+" ‚Ç¨";
  }
}

function renderDivHistory(events){
  const tbody=document.querySelector("#divHistoryTable tbody");
  tbody.innerHTML="";
  const totalCell=document.getElementById("totalDivHistory");
  let total=0;
  if(!events.length){
    tbody.innerHTML=`<tr><td colspan="5" class="text-small">Aucun dividende encore d√©tach√©.</td></tr>`;
    totalCell.textContent=fmtEuro(0);
    return;
  }
  events.forEach(e=>{
    total+=e.amount;
    tbody.innerHTML+=`
      <tr>
        <td>${e.date}</td>
        <td class="text-left">${e.ticker}</td>
        <td>${e.qty.toFixed(4)}</td>
        <td>${e.perShare.toFixed(4)}</td>
        <td>${e.amount.toFixed(2)}</td>
      </tr>`;
  });
  totalCell.textContent=fmtEuro(total);
}

/* PV r√©alis√©es */
function renderPV(){
  const tbody=document.querySelector("#pvTable tbody");
  tbody.innerHTML="";
  const totalCell=document.getElementById("totalPV");
  totalCell.textContent="‚Äì";
  const info=computeFromOperations();
  const realized=info.realized;
  const totalPV=info.totalPV;
  if(!realized.length){
    tbody.innerHTML=`<tr><td colspan="8" class="text-small">Aucune vente.</td></tr>`;
    document.getElementById("kpiPVReal").textContent=fmtEuro(0);
    return;
  }
  realized.forEach(r=>{
    tbody.innerHTML+=`
      <tr>
        <td>${r.date}</td>
        <td class="text-left">${r.ticker}</td>
        <td>${r.qty}</td>
        <td>${r.pruBefore.toFixed(4)}</td>
        <td>${r.price.toFixed(4)}</td>
        <td>${r.fees.toFixed(2)}</td>
        <td style="color:${r.pl>=0?"#4ade80":"#f87171"}">${r.pl.toFixed(2)} ‚Ç¨</td>
        <td style="color:${r.plPct>=0?"#4ade80":"#f87171"}">${r.plPct.toFixed(2)}%</td>
      </tr>`;
  });
  totalCell.textContent=fmtEuro(totalPV);
  document.getElementById("kpiPVReal").textContent=fmtEuro(totalPV);
}

/* ========= 8. R√âSUM√â ========= */
function setKpiColored(id,val){
  const el=document.getElementById(id);
  el.textContent=fmtEuro(val);
  el.classList.remove("positive","negative");
  if(val>0)el.classList.add("positive");
  if(val<0)el.classList.add("negative");
}
function renderSummary(){
  const info=computeFromOperations();
  const positions=info.positions;
  const totalBuys=info.totalBuys;
  const totalSells=info.totalSells;
  const totalPV=info.totalPV;
  const divInfo=computeDividendsReceived();
  const divTotal=divInfo.total;
  const portInfo=computePortfolioWithPrices();
  const totalValo=portInfo.totalValo;
  const totalPL=portInfo.totalPL;
  let investiActuel=0;
  Object.keys(positions).forEach(t=>{investiActuel+=positions[t].cost;});
  const cashFromMoves=cashMoves.reduce((s,m)=>s+(m.type==="in"?m.amount:-m.amount),0);
  const cashTheo=totalSells-totalBuys+cashFromMoves+divTotal;

  document.getElementById("kpiValeurTotale").textContent=fmtEuro(totalValo||investiActuel);
  document.getElementById("kpiInvestiActuel").textContent=fmtEuro(investiActuel);
  setKpiColored("kpiPVLatente",totalPL);
  setKpiColored("kpiPVReal",totalPV);
  setKpiColored("kpiDivRecus",divTotal);
  setKpiColored("kpiCash",cashTheo);
}

/* ========= 9. PRIX / S√âRIES YAHOO & INTRADAY ALPHA ========= */

// Prix "Alpha" (mais via Yahoo Netlify ici)
async function fetchPriceAlpha(ticker){
  try{
    const url = YAHOO_ENDPOINT
      + "?symbol=" + encodeURIComponent(ticker)
      + "&range=1d&interval=1d";

    return fetch(url)
      .then(res => {
        if(!res.ok) return null;
        return res.json();
      })
      .then(data => {
        if(!data || !data.chart || !data.chart.result || !data.chart.result[0]) return null;
        const result = data.chart.result[0];
        const quote  = result.indicators && result.indicators.quote && result.indicators.quote[0];
        if(!quote || !quote.close || !quote.close.length) return null;

        const closes = quote.close.filter(v => typeof v === "number");
        if(!closes.length) return null;
        const price = closes[closes.length-1];

        let changePct = 0;
        if(closes.length >= 2){
          const prev = closes[closes.length-2];
          if(prev && prev !== 0){
            changePct = (price - prev) / prev * 100;
          }
        }

        return {
          price: price,
          changePct: changePct,
          lastUpdate: new Date().toISOString()
        };
      })
      .catch(e => {
        console.error("Erreur Yahoo (price)", ticker, e);
        return null;
      });
  }catch(e){
    console.error("Exception Yahoo (price)", ticker, e);
    return null;
  }
}

// S√©ries daily (Yahoo)
async function fetchSeriesAlpha(ticker){
  try{
    const url = YAHOO_ENDPOINT
      + "?symbol=" + encodeURIComponent(ticker)
      + "&range=5y&interval=1d";

    return fetch(url)
      .then(res => {
        if(!res.ok){
          return { error: "Erreur r√©seau Yahoo (" + res.status + ")" };
        }
        return res.json();
      })
      .then(data => {
        if(!data || !data.chart || !data.chart.result || !data.chart.result[0]){
          return { error: "R√©ponse Yahoo invalide." };
        }
        const result     = data.chart.result[0];
        const timestamps = result.timestamp || [];
        const quote      = result.indicators && result.indicators.quote && result.indicators.quote[0];
        if(!quote || !quote.close || !timestamps.length){
          return { error: "Donn√©es Yahoo incompl√®tes." };
        }

        const closesRaw = quote.close || [];
        const tsFiltered = [];
        const closeFiltered = [];
        for(let i=0;i<timestamps.length;i++){
          const c = closesRaw[i];
          if(typeof c === "number"){
            tsFiltered.push(timestamps[i]);
            closeFiltered.push(c);
          }
        }
        if(!tsFiltered.length){
          return { error: "Aucune cl√¥ture exploitable." };
        }

        priceSeries[ticker] = {
          timestamps: tsFiltered,
          closes: closeFiltered,
          lastUpdate: new Date().toISOString()
        };
        saveJSON(STORAGE_SERIES, priceSeries);
        return { ok:true };
      })
      .catch(e => {
        console.error("Erreur Yahoo (series)", ticker, e);
        return { error: "Exception s√©rie Yahoo." };
      });
  }catch(e){
    console.error("Exception Yahoo (series)", ticker, e);
    return { error: "Exception s√©rie Yahoo." };
  }
}

/* S√©ries intraday 1J via Alpha (Netlify) */
async function fetchSeriesAlphaIntraday(ticker){
  try{
    const url = ALPHA_ENDPOINT
      + "?symbol=" + encodeURIComponent(ticker)
      + "&range=1d&interval=1min"; // adapte si besoin c√¥t√© Netlify

    const res = await fetch(url);
    if(!res.ok){
      console.error("Erreur r√©seau Alpha intraday", ticker, res.status);
      return { error:"Erreur r√©seau Alpha" };
    }
    const data = await res.json();

    // On suppose un format simple { timestamps:[], closes:[] }
    if(!data || !Array.isArray(data.timestamps) || !Array.isArray(data.closes) || !data.timestamps.length){
      console.error("R√©ponse Alpha intraday invalide", ticker, data);
      return { error:"Donn√©es Alpha intraday invalides" };
    }

    intradaySeries[ticker] = {
      timestamps: data.timestamps,
      closes: data.closes,
      lastUpdate: new Date().toISOString()
    };
    saveJSON(STORAGE_SERIES_INTRADAY, intradaySeries);
    return { ok:true };
  }catch(e){
    console.error("Exception Alpha intraday", ticker, e);
    return { error:"Exception Alpha intraday" };
  }
}

async function ensureIntradaySeries(ticker){
  if(
    intradaySeries[ticker] &&
    Array.isArray(intradaySeries[ticker].timestamps) &&
    intradaySeries[ticker].timestamps.length
  ){
    return;
  }
  await fetchSeriesAlphaIntraday(ticker);
}

async function refreshAllPrices(silent){
  const info = computeFromOperations();
  const positions = info.positions;
  const tickers = Object.keys(positions).filter(t => positions[t].quantity > 0);
  if(!tickers.length){
    if(!silent) alert("Aucune position ouverte.");
    return;
  }

  for(const t of tickers){
    const res = await fetchPriceAlpha(t);
    if(res){
      prices[t] = res;
    }
  }
  saveJSON(STORAGE_PRICES, prices);
  renderPortfolio();
  renderSummary();
  updateAllocChart();
  updatePLChart();
  if(!silent) alert("Cours mis √† jour.");
}

function clearPrices(){
  if(!confirm("Effacer tous les cours enregistr√©s ?")) return;
  prices = {};
  saveJSON(STORAGE_PRICES, prices);
  renderPortfolio();
  renderSummary();
  updateAllocChart();
  updatePLChart();
}

/* Recharger uniquement le ticker s√©lectionn√© dans la liste d√©roulante */
async function refreshCurrentTickerSeries(){
  const sel = document.getElementById("tickerDetailSelect");
  if(!sel || !sel.value) return;

  const ticker = sel.value;
  await fetchSeriesAlpha(ticker); // 5 ans daily
  if(currentTickerPeriod === "1J"){
    await ensureIntradaySeries(ticker);
  }
  updateTickerDetailChart();
}

/* S√©ries de tous les tickers (graphes) */
async function refreshAllSeries(silent){
  const info = computeFromOperations();
  const positions = info.positions;
  const baseTickers = Object.keys(positions).filter(t => positions[t].quantity > 0);
  const extra = watchFavorites.filter(t => !baseTickers.includes(t));
  const tickers = [...baseTickers, ...extra];
  if(!tickers.length){
    if(!silent) alert("Aucun ticker √† mettre √† jour.");
    return;
  }

  for(const t of tickers){
    await fetchSeriesAlpha(t);      // daily
    await fetchSeriesAlphaIntraday(t); // intraday 1J
  }
  updateTickerSelectOptions();
  updateAllocChart();
  updatePLChart();
  updateTickerDetailChart();
  updatePortfolioCurveChart();
  if(currentWatchTicker) updateWatchlistChart();
  if(!silent) alert("S√©ries historiques mises √† jour.");
}

/* ========= 10. GRAPHES (Chart.js) ========= */
let chartAlloc          = null;
let chartPL             = null;
let chartTickerDetail   = null;
let chartPortfolioCurve = null;
let chartWatchlist      = null;
let tickerCompareBase   = null;   // point de d√©part pour la comparaison
let portfolioCompareBase= null;
let watchCompareBase    = null;

function getSliceStartIndex(len, period){
  if(!len) return 0;
  const map = {
    "1J":  80,   // plus de points intraday
    "1S":  7,
    "1M":  22,
    "3M":  66,
    "6M":  132,
    "1A":  260,
    "2A":  520,
    "5A":  1300
  };
  if(period === "MAX" || !map[period] || map[period] >= len) return 0;
  return Math.max(0, len - map[period]);
}

function getSeriesForTicker(ticker, period){
  // Pour 1J on privil√©gie les s√©ries intraday Alpha (si dispo),
  // sinon on retombe sur les s√©ries daily Yahoo.
  const s = (period === "1J" && intradaySeries[ticker])
    ? intradaySeries[ticker]
    : priceSeries[ticker];

  if(!s || !s.timestamps || !s.timestamps.length) return null;
  const labels = s.timestamps.map(ts => {
    const d = new Date(ts*1000);
    // Pour simplifier, on reste en YYYY-MM-DD (m√™me en 1J).
    return d.toISOString().slice(0,10);
  });
  const values = s.closes.slice();
  const start = getSliceStartIndex(labels.length, period);
  return {
    labels: labels.slice(start),
    values: values.slice(start)
  };
}

/* R√©partition par valeur (doughnut) */
function updateAllocChart(){
  const canvas = document.getElementById("chartAlloc");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const port = computePortfolioWithPrices();
  const lines = port.lines;
  const labels = lines.map(l => l.ticker);
  const data   = lines.map(l => l.valo);

  if(chartAlloc) chartAlloc.destroy();
  if(!labels.length){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    chartAlloc = null;
    return;
  }

  chartAlloc = new Chart(ctx,{
    type:"doughnut",
    data:{
      labels,
      datasets:[{
        data,
        borderWidth:0
      }]
    },
    options:{
      plugins:{
        legend:{
          labels:{ color:"#e5e7eb", font:{ size:11 } }
        }
      },
      cutout:"60%"
    }
  });
}

/* PV latente par valeur (barres vert / rouge) */
function updatePLChart(){
  const canvas = document.getElementById("chartPL");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const port = computePortfolioWithPrices();
  const lines = port.lines;
  const labels = lines.map(l => l.ticker);
  const data   = lines.map(l => l.pl);

  if(chartPL) chartPL.destroy();
  if(!labels.length){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    chartPL = null;
    return;
  }

  const colors = data.map(v => v >= 0 ? "rgba(34,197,94,0.9)" : "rgba(248,113,113,0.9)");
  const border = data.map(v => v >= 0 ? "rgba(34,197,94,1)"   : "rgba(248,113,113,1)");

  chartPL = new Chart(ctx,{
    type:"bar",
    data:{
      labels,
      datasets:[{
        data,
        backgroundColor: colors,
        borderColor: border,
        borderWidth:1
      }]
    },
    options:{
      plugins:{
        legend:{ display:false },
      },
      scales:{
        x:{
          ticks:{ color:"#e5e7eb", font:{ size:10 } },
          grid:{ color:"rgba(148,163,184,0.1)" }
        },
        y:{
          ticks:{ color:"#e5e7eb", font:{ size:10 } },
          grid:{ color:"rgba(148,163,184,0.1)" }
        }
      }
    }
  });
}

/* Graphique ticker d√©tail ‚Äì style Google, 1J moins liss√© + padding Y */
async function updateTickerDetailChart(){
  const canvas = document.getElementById("chartTickerDetail");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const select = document.getElementById("tickerDetailSelect");
  if(!select || !select.value){
    if(chartTickerDetail){ chartTickerDetail.destroy(); chartTickerDetail=null; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  const ticker = select.value;

  // Si 1J, on s'assure d'avoir l'intraday Alpha
  if(currentTickerPeriod === "1J"){
    await ensureIntradaySeries(ticker);
  }

  const s = getSeriesForTicker(ticker, currentTickerPeriod);
  if(!s){
    if(chartTickerDetail){ chartTickerDetail.destroy(); chartTickerDetail=null; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }

  const labels = s.labels;
  const values = s.values;

  if(chartTickerDetail) chartTickerDetail.destroy();

  const gradient = ctx.createLinearGradient(0,0,0,canvas.height);
  gradient.addColorStop(0,"rgba(56,189,248,0.75)");   // plus clair
  gradient.addColorStop(1,"rgba(15,23,42,0)");

  const tensionVal = (currentTickerPeriod === "1J") ? 0.05 : 0.35; // moins liss√© sur 1J

  let minV = Math.min(...values);
  let maxV = Math.max(...values);
  const pad = (maxV - minV) * 0.05 || 1;
  minV -= pad;
  maxV += pad;

  chartTickerDetail = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[{
        data:values,
        borderWidth:3,
        borderColor:"#38bdf8",
        fill:true,
        backgroundColor:gradient,
        pointRadius:(currentTickerPeriod === "1J") ? 1.5 : 0,
        pointHitRadius:6,
        tension:tensionVal
      }]
    },
    options:{
      plugins:{
        legend:{ display:false },
        tooltip:{
          mode:"index",
          intersect:false,
          callbacks:{
            label:(ctx)=> fmtEuro(ctx.parsed.y)
          }
        }
      },
      scales:{
        x:{
          display:true,
          ticks:{ color:"#9ca3af", maxTicksLimit:6, font:{ size:10 } },
          grid:{ display:false }
        },
        y:{
          ticks:{ color:"#9ca3af", font:{ size:10 } },
          grid:{ color:"rgba(148,163,184,0.12)" },
          suggestedMin: minV,
          suggestedMax: maxV
        }
      }
    }
  });

  // Comparaison 2 points si besoin (m√™me logique que watch/portefeuille possible ici si tu veux)
}

/* Courbe portefeuille (avec / sans dividendes) style Google */
function buildPortfolioTimeSeries(){
  const tickers = Object.keys(priceSeries);
  if(!tickers.length) return { labels:[], withoutDiv:[], withDiv:[] };

  const tsSet = new Set();
  tickers.forEach(t=>{
    const s = priceSeries[t];
    if(s && s.timestamps){
      s.timestamps.forEach(ts => tsSet.add(ts));
    }
  });
  const allTs = Array.from(tsSet).sort((a,b)=>a-b);
  if(!allTs.length) return { labels:[], withoutDiv:[], withDiv:[] };

  const closeMap = {};
  tickers.forEach(t=>{
    const s = priceSeries[t];
    if(!s || !s.timestamps) return;
    closeMap[t] = {};
    s.timestamps.forEach((ts,i)=>{
      closeMap[t][ts] = s.closes[i];
    });
  });

  const divInfo = computeDividendsReceived();
  const divEvents = divInfo.events.slice().sort((a,b)=>a.date.localeCompare(b.date));
  let divIndex = 0;
  let divCum   = 0;

  const labels     = [];
  const withoutDiv = [];
  const withDiv    = [];

  allTs.forEach(ts=>{
    const d = new Date(ts*1000);
    const iso = d.toISOString().slice(0,10);
    labels.push(iso);

    while(divIndex < divEvents.length && divEvents[divIndex].date <= iso){
      divCum += divEvents[divIndex].amount;
      divIndex++;
    }

    let totalValo = 0;
    tickers.forEach(t=>{
      const price = closeMap[t][ts];
      if(typeof price !== "number") return;
      const qty = getQuantityAtDate(t, iso);
      if(qty > 0){
        totalValo += qty * price;
      }
    });
    withoutDiv.push(totalValo);
    withDiv.push(totalValo + divCum);
  });

  return { labels, withoutDiv, withDiv };
}

function updatePortfolioCurveChart(){
  const canvas = document.getElementById("chartPortfolioCurve");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  const base = buildPortfolioTimeSeries();
  if(!base.labels.length){
    if(chartPortfolioCurve){ chartPortfolioCurve.destroy(); chartPortfolioCurve=null; }
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const infoEl = document.getElementById("portfolioCompareInfo");
    if(infoEl){
      infoEl.textContent = "Aucune donn√©e √† afficher pour le portefeuille.";
    }
    portfolioCompareBase = null;
    canvas.onclick = null;
    return;
  }

  const start = getSliceStartIndex(base.labels.length, currentPortfolioPeriod);
  const labels     = base.labels.slice(start);
  const withoutDiv = base.withoutDiv.slice(start);
  const withDiv    = base.withDiv.slice(start);

  if(chartPortfolioCurve) chartPortfolioCurve.destroy();

  const grad2 = ctx.createLinearGradient(0,0,0,canvas.height);
  grad2.addColorStop(0,"rgba(34,197,94,0.40)");
  grad2.addColorStop(1,"rgba(15,23,42,0)");

  const allVals = [...withoutDiv, ...withDiv].filter(v => typeof v === "number");
  let minV = Math.min(...allVals);
  let maxV = Math.max(...allVals);
  const pad = (maxV - minV) * 0.05 || 10;
  minV = Math.max(0, minV - pad);
  maxV += pad;

  chartPortfolioCurve = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {
          label:"Sans dividendes",
          data:withoutDiv,
          borderWidth:3,
          borderColor:"#38bdf8",
          fill:false,
          pointRadius:0,
          tension:0.25
        },
        {
          label:"Avec dividendes",
          data:withDiv,
          borderWidth:2.2,
          borderColor:"#22c55e",
          fill:true,
          backgroundColor:grad2,
          pointRadius:0,
          tension:0.25
        }
      ]
    },
    options:{
      plugins:{
        legend:{
          labels:{ color:"#e5e7eb", font:{ size:11 } }
        },
        tooltip:{
          mode:"index",
          intersect:false,
          callbacks:{
            label:(ctx)=> ctx.dataset.label + " : " + fmtEuro(ctx.parsed.y)
          }
        }
      },
      scales:{
        x:{
          ticks:{ color:"#9ca3af", maxTicksLimit:6, font:{ size:10 } },
          grid:{ display:false }
        },
        y:{
          ticks:{ color:"#9ca3af", font:{ size:10 } },
          grid:{ color:"rgba(148,163,184,0.10)" },
          suggestedMin: minV,
          suggestedMax: maxV
        }
      }
    }
  });

  const infoEl = document.getElementById("portfolioCompareInfo");
  portfolioCompareBase = null;
  if(infoEl){
    infoEl.textContent =
      "Astuce : touche un point pour fixer la date de d√©part, puis un autre pour voir l'√©volution entre les deux dates.";
  }

  canvas.onclick = (evt) => {
    if(!chartPortfolioCurve) return;
    const points = chartPortfolioCurve.getElementsAtEventForMode(
      evt,
      "nearest",
      { intersect:false },
      true
    );
    if(!points.length) return;

    const p      = points[0];
    const index  = p.index;
    const ds     = chartPortfolioCurve.data.datasets[p.datasetIndex];
    const label  = chartPortfolioCurve.data.labels[index];
    const value  = ds.data[index];

    if(!infoEl) return;

    if(!portfolioCompareBase){
      portfolioCompareBase = { index, label, value, dsLabel: ds.label };
      infoEl.textContent =
        `Point A (${ds.label}) : ${label} ‚Äì ${value.toFixed(2)} ‚Ç¨`;
      return;
    }

    const diffVal = value - portfolioCompareBase.value;
    const diffPct = portfolioCompareBase.value
      ? (diffVal / portfolioCompareBase.value) * 100
      : 0;

    const diffValStr = (diffVal >= 0 ? "+" : "") + diffVal.toFixed(2) + " ‚Ç¨";
    const diffPctStr = (diffPct >= 0 ? "+" : "") + diffPct.toFixed(2) + " %";

    infoEl.textContent =
      `De ${portfolioCompareBase.label} (${portfolioCompareBase.dsLabel}, ` +
      `${portfolioCompareBase.value.toFixed(2)} ‚Ç¨)` +
      ` √† ${label} (${ds.label}, ${value.toFixed(2)} ‚Ç¨) : ` +
      `${diffValStr} (${diffPctStr})`;

    portfolioCompareBase = null;
  };
}

/* ========= 11. WATCHLIST (style Google) ========= */
function renderWatchlistTable(){
  const tbody = document.querySelector("#watchlistTable tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  if(!watchRows.length){
    tbody.innerHTML = `<tr><td colspan="5" class="text-small">Aucun ticker dans la watchlist.</td></tr>`;
    return;
  }
  watchRows.forEach(row=>{
    const fav = watchFavorites.includes(row.ticker);
    const priceStr = (typeof row.price === "number") ? row.price.toFixed(2) : "‚Äì";
    const pctStr   = (typeof row.changePct === "number") ? row.changePct.toFixed(2) + " %" : "‚Äì";
    const pctColor = (typeof row.changePct === "number")
      ? (row.changePct >= 0 ? "#4ade80" : "#f87171")
      : "#e5e7eb";

    tbody.innerHTML += `
      <tr>
        <td class="text-left">
          <button class="btn btn-ghost" type="button" onclick="setWatchChartTicker('${row.ticker}')">${row.ticker}</button>
        </td>
        <td>${priceStr}</td>
        <td style="color:${pctColor}">${pctStr}</td>
        <td>
          <button class="btn btn-ghost" type="button" onclick="toggleWatchFavorite('${row.ticker}')">
            ${fav ? "‚òÖ" : "‚òÜ"}
          </button>
        </td>
        <td>
          <button class="btn btn-primary" type="button" onclick="setWatchChartTicker('${row.ticker}')">
            Graphique
          </button>
        </td>
      </tr>`;
  });
}

function renderWatchFavorites(){
  const row = document.getElementById("watch-fav-row");
  if(!row) return;
  row.innerHTML = "";
  if(!watchFavorites.length){
    row.innerHTML = `<span class="text-small">Aucun favori pour l‚Äôinstant.</span>`;
    return;
  }
  watchFavorites.forEach(t=>{
    const btn = document.createElement("button");
    btn.className = "chip-btn";
    btn.textContent = t;
    btn.onclick = ()=>setWatchChartTicker(t);
    row.appendChild(btn);
  });
}

async function addWatchTicker(){
  const input = document.getElementById("watch-ticker-input");
  if(!input) return;
  const raw = input.value.trim();
  if(!raw){ alert("Entre un ticker."); return; }
  const ticker = normalizeTicker(raw);
  if(!ticker){ alert("Ticker invalide."); return; }

  if(watchRows.find(r=>r.ticker === ticker)){
    setWatchChartTicker(ticker);
    input.value = "";
    return;
  }

  const row = { ticker, price:null, changePct:null };
  watchRows.push(row);
  input.value = "";
  renderWatchlistTable();

  const priceInfo = await fetchPriceAlpha(ticker);
  if(priceInfo){
    prices[ticker] = priceInfo;
    saveJSON(STORAGE_PRICES, prices);
    const r = watchRows.find(rr=>rr.ticker===ticker);
    if(r){
      r.price = priceInfo.price;
      r.changePct = priceInfo.changePct;
    }
    renderWatchlistTable();
  }

  await fetchSeriesAlpha(ticker);
  await fetchSeriesAlphaIntraday(ticker);
  renderWatchlistTable();
}

function clearWatchTable(){
  if(!confirm("Vider le tableau de watchlist (les favoris restent) ?")) return;
  watchRows = [];
  renderWatchlistTable();
}

function toggleWatchFavorite(ticker){
  const idx = watchFavorites.indexOf(ticker);
  if(idx >= 0){
    watchFavorites.splice(idx,1);
  }else{
    if(watchFavorites.length >= 4){
      alert("Maximum 4 favoris.");
      return;
    }
    watchFavorites.push(ticker);
  }
  saveJSON(STORAGE_WATCH_FAV, watchFavorites);
  renderWatchFavorites();
}

function setWatchChartTicker(ticker){
  currentWatchTicker = ticker;
  ensureSeriesForWatchTicker(ticker);
}

async function ensureSeriesForWatchTicker(ticker){
  if(!priceSeries[ticker] || !priceSeries[ticker].timestamps || !priceSeries[ticker].timestamps.length){
    await fetchSeriesAlpha(ticker);
  }
  if(currentWatchPeriod === "1J"){
    await ensureIntradaySeries(ticker);
  }
  updateWatchlistChart();
}

async function updateWatchlistChart(){
  const canvas = document.getElementById("chartWatchlist");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");
  const infoEl = document.getElementById("watchCompareInfo");

  if(!currentWatchTicker){
    if(chartWatchlist){ chartWatchlist.destroy(); chartWatchlist=null; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(infoEl){
      infoEl.textContent = "Aucune donn√©e √† afficher pour ce ticker.";
    }
    watchCompareBase = null;
    canvas.onclick = null;
    return;
  }

  if(currentWatchPeriod === "1J"){
    await ensureIntradaySeries(currentWatchTicker);
  }
  const s = getSeriesForTicker(currentWatchTicker, currentWatchPeriod);
  if(!s){
    if(chartWatchlist){ chartWatchlist.destroy(); chartWatchlist=null; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(infoEl){
      infoEl.textContent = "Aucune donn√©e √† afficher pour ce ticker.";
    }
    watchCompareBase = null;
    canvas.onclick = null;
    return;
  }

  const labels = s.labels;
  const values = s.values;

  if(chartWatchlist) chartWatchlist.destroy();

  const gradient = ctx.createLinearGradient(0,0,0,canvas.height);
  gradient.addColorStop(0,"rgba(56,189,248,0.75)");
  gradient.addColorStop(1,"rgba(15,23,42,0)");

  let minV = Math.min(...values);
  let maxV = Math.max(...values);
  const pad = (maxV - minV) * 0.05 || 1;
  minV -= pad;
  maxV += pad;

  chartWatchlist = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[{
        data:values,
        borderWidth:3,
        borderColor:"#38bdf8",
        fill:true,
        backgroundColor:gradient,
        pointRadius:0,
        tension:0.30
      }]
    },
    options:{
      plugins:{
        legend:{ display:false },
        tooltip:{
          mode:"index",
          intersect:false,
          callbacks:{
            label:(ctx)=> fmtEuro(ctx.parsed.y)
          }
        }
      },
      scales:{
        x:{
          ticks:{ color:"#9ca3af", maxTicksLimit:6, font:{ size:10 } },
          grid:{ display:false }
        },
        y:{
          ticks:{ color:"#9ca3af", font:{ size:10 } },
          grid:{ color:"rgba(148,163,184,0.10)" },
          suggestedMin: minV,
          suggestedMax: maxV
        }
      }
    }
  });

  // reset du point de comparaison √† chaque redraw
  watchCompareBase = null;
  if(infoEl){
    infoEl.textContent = "Astuce : touche un point pour fixer la date de d√©part, puis un autre pour voir l'√©cart entre les deux.";
  }

  canvas.onclick = (evt) => {
    if(!chartWatchlist) return;
    const points = chartWatchlist.getElementsAtEventForMode(
      evt,
      "nearest",
      { intersect:false },
      true
    );
    if(!points.length) return;

    const p      = points[0];
    const index  = p.index;
    const label  = chartWatchlist.data.labels[index];
    const value  = chartWatchlist.data.datasets[0].data[index];

    if(!infoEl) return;

    if(!watchCompareBase){
      watchCompareBase = { index, label, value };
      infoEl.textContent = `Point A : ${label} ‚Äì ${value.toFixed(2)} ‚Ç¨`;
      return;
    }

    const diffVal = value - watchCompareBase.value;
    const diffPct = watchCompareBase.value
      ? (diffVal / watchCompareBase.value) * 100
      : 0;

    const diffValStr = (diffVal >= 0 ? "+" : "") + diffVal.toFixed(2) + " ‚Ç¨";
    const diffPctStr = (diffPct >= 0 ? "+" : "") + diffPct.toFixed(2) + " %";

    infoEl.textContent =
      `De ${watchCompareBase.label} (${watchCompareBase.value.toFixed(2)} ‚Ç¨)` +
      ` √† ${label} (${value.toFixed(2)} ‚Ç¨) : ` +
      `${diffValStr} (${diffPctStr})`;

    watchCompareBase = null;
  };
}

/* ========= 12. CALCULATRICE PRU ========= */
function recalcPRU(){
  const current = parseFloat((document.getElementById("pru-current").value||"").replace(",","."));  
  const currentQty = parseFloat((document.getElementById("pru-current-qty").value||"").replace(",","."));  
  const addQty = parseFloat((document.getElementById("pru-add-qty").value||"").replace(",","."));  
  const addPrice = parseFloat((document.getElementById("pru-add-price").value||"").replace(",","."));  
  const addFees = parseFloat((document.getElementById("pru-add-fees").value||"0").replace(",","."));  

  let newPRU = NaN;
  let totalInvest = NaN;
  const qty0 = isNaN(currentQty)?0:currentQty;
  const prix0 = isNaN(current)?0:current;
  const qtyA = isNaN(addQty)?0:addQty;
  const prixA = isNaN(addPrice)?0:addPrice;
  const feesA = isNaN(addFees)?0:addFees;

  const cost0 = qty0 * prix0;
  const costA = qtyA * prixA + feesA;
  const qtyTot = qty0 + qtyA;
  if(qtyTot>0){
    totalInvest = cost0 + costA;
    newPRU = totalInvest / qtyTot;
  }

  document.getElementById("pru-new").textContent =
    isNaN(newPRU)? "‚Äì" : newPRU.toFixed(4) + " ‚Ç¨";
  document.getElementById("pru-total-invest").textContent =
    isNaN(totalInvest)? "‚Äì" : totalInvest.toFixed(2) + " ‚Ç¨";

  const targetPrice = parseFloat((document.getElementById("pru-target-price").value||"").replace(",","."));  
  const targetGain  = parseFloat((document.getElementById("pru-target-gain").value||"").replace(",","."));  

  let pl = NaN, plPct = NaN, priceFromGain = NaN;

  if(!isNaN(targetPrice) && qtyTot>0 && !isNaN(newPRU)){
    const valueAtTarget = targetPrice * qtyTot;
    const cost = newPRU * qtyTot;
    pl = valueAtTarget - cost;
    plPct = cost ? (pl / cost) * 100 : NaN;
  }

  if(!isNaN(targetGain) && qtyTot>0 && !isNaN(newPRU)){
    priceFromGain = newPRU + (targetGain / qtyTot);
  }

  document.getElementById("pru-target-pl").textContent =
    isNaN(pl) ? "‚Äì" : pl.toFixed(2) + " ‚Ç¨";
  document.getElementById("pru-target-pl-pct").textContent =
    isNaN(plPct) ? "‚Äì" : plPct.toFixed(2) + " %";
  document.getElementById("pru-target-price-from-gain").textContent =
    isNaN(priceFromGain) ? "‚Äì" : priceFromGain.toFixed(4) + " ‚Ç¨";
}

/* ========= 13. TICKER DETAIL SELECT ========= */
function updateTickerSelectOptions(){
  const sel = document.getElementById("tickerDetailSelect");
  if(!sel) return;
  const info = computeFromOperations();
  const positions = info.positions;
  const baseTickers = Object.keys(positions).filter(t=>positions[t].quantity>0);
  const extra = watchFavorites.filter(t=>!baseTickers.includes(t));
  const all = [...baseTickers, ...extra];

  sel.innerHTML = "";
  if(!all.length){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Aucune valeur";
    sel.appendChild(opt);
    return;
  }
  all.forEach(t=>{
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    sel.appendChild(opt);
  });
  if(!sel.value) sel.value = all[0];
}

/* ========= 14. RENDU GLOBAL & RESET ========= */
function renderAll(){
  renderOperations();
  renderCashHistory();
  renderPortfolio();
  renderDividends();
  renderPV();
  renderSummary();
  renderWatchlistTable();
  renderWatchFavorites();
  updateTickerSelectOptions();
  updateAllocChart();
  updatePLChart();
  updateTickerDetailChart();
  updatePortfolioCurveChart();
  updateWatchlistChart();
}

function clearAllData(){
  if(!confirm("Tout r√©initialiser (op√©rations, dividendes, cash, notes, cours, s√©ries, favoris) ?")) return;
  operations = [];
  dividends  = [];
  cashMoves  = [];
  notes      = {};
  prices     = {};
  priceSeries= {};
  intradaySeries = {};
  watchFavorites = [];
  watchRows  = [];

  saveJSON(STORAGE_OPS, operations);
  saveJSON(STORAGE_DIVCFG, dividends);
  saveJSON(STORAGE_CASH, cashMoves);
  saveJSON(STORAGE_NOTES, notes);
  saveJSON(STORAGE_PRICES, prices);
  saveJSON(STORAGE_SERIES, priceSeries);
  saveJSON(STORAGE_SERIES_INTRADAY, intradaySeries);
  saveJSON(STORAGE_WATCH_FAV, watchFavorites);

  if(chartAlloc){ chartAlloc.destroy(); chartAlloc=null; }
  if(chartPL){ chartPL.destroy(); chartPL=null; }
  if(chartTickerDetail){ chartTickerDetail.destroy(); chartTickerDetail=null; }
  if(chartPortfolioCurve){ chartPortfolioCurve.destroy(); chartPortfolioCurve=null; }
  if(chartWatchlist){ chartWatchlist.destroy(); chartWatchlist=null; }

  renderAll();
}

/* ========= 15. LISTENERS INIT ========= */
function initPRUListeners(){
  const ids = [
    "pru-current","pru-current-qty",
    "pru-add-qty","pru-add-price","pru-add-fees",
    "pru-target-price","pru-target-gain"
  ];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", recalcPRU);
  });
}

function initPeriodButtons(){
  // Ticker d√©tail
  document.querySelectorAll("#tickerPeriodRow .chip-btn").forEach(btn=>{
    btn.addEventListener("click",async ()=>{
      document.querySelectorAll("#tickerPeriodRow .chip-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentTickerPeriod = btn.dataset.tickerPeriod;
      await updateTickerDetailChart();
    });
  });

  // Portefeuille
  document.querySelectorAll("#portfolioPeriodRow .chip-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      document.querySelectorAll("#portfolioPeriodRow .chip-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentPortfolioPeriod = btn.dataset.portfolioPeriod;
      updatePortfolioCurveChart();
    });
  });

  // Watchlist
  document.querySelectorAll("#watch-period-row .chip-btn").forEach(btn=>{
    btn.addEventListener("click",async ()=>{
      document.querySelectorAll("#watch-period-row .chip-btn").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentWatchPeriod = btn.dataset.watchPeriod;
      if(currentWatchTicker) await updateWatchlistChart();
    });
  });

  // changement valeur d√©tail
  const sel = document.getElementById("tickerDetailSelect");
  if(sel){
    sel.addEventListener("change",()=>updateTickerDetailChart());
  }
}

/* ========= 16. BOOT ========= */
renderAll();
initPRUListeners();
initPeriodButtons();
</script>
</body>
</html>